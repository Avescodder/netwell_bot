name: Smart Merge Pipeline

on:
  push:
    branches: [ dev ]

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Check syntax
        run: |
          python -m py_compile bot.py sample_vendors.py
          echo "‚úÖ Syntax check passed"

  create-pr:
    name: Create PR
    needs: tests
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create-pr.outputs.pull-request-number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create Pull Request
        id: create-pr
        uses: repo-sync/pull-request@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: dev
          destination_branch: main
          pr_title: "üöÄ Deploy: dev ‚Üí main"
          pr_body: |
            ## –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é
            
            ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
            üì¶ –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            
            ### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
            ${{ github.event.head_commit.message }}
            
            ---
            **–°–º–µ—Ä–∂–∏ –¥–ª—è –∞–≤—Ç–æ–¥–µ–ø–ª–æ—è –Ω–∞ production!**
          pr_label: "auto-deploy"

#   notify:
#     name: Send Notification
#     needs: create-pr
#     runs-on: ubuntu-latest
#     steps:
#       - name: Notify Telegram
#         uses: appleboy/telegram-action@master
#         with:
#           to: ${{ secrets.TELEGRAM_CHAT_ID }}
#           token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
#           message: |
#             ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!
            
#             dev ‚Üí main (PR #${{ needs.create-pr.outputs.pr_number }})
            
#             –°–º–µ—Ä–∂–∏ PR –¥–ª—è –¥–µ–ø–ª–æ—è:
#             https://github.com/${{ github.repository }}/pull/${{ needs.create-pr.outputs.pr_number }}
            
#             –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏:
#             git checkout main && git merge dev && git push